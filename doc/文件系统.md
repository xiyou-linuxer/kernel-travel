# 文件系统

在 kernel-travel 中文件系统采取多层次的实现方式

![Alt text](./img/image.png)

## 缓冲层

由于每次I/O操作要耗费大量的时间与计算机资源，因此设计缓冲层，尽量减少对于磁盘设备的访问。

缓冲层采取 LRU 的换出策略，使用动态分配内存的方式将经常用到的文件块保存在内存中，将长期不用的文件块从磁盘呢换出至磁盘内。

当物理内存的使用率达到一定程度后，由内核线程 bufSync 将缓冲区中的内容强制回写到磁盘中。

缓冲层以块为单位进行管理。将内存中的每512字节与磁盘上的一个扇区对应。

![Alt text](./img/image1.png)

```c
typedef struct Buffer {
    unsigned long blockno;//控制块号
    int dev;
    bool valid;//缓冲区的有效标志
    bool dirty;//是否被写入的标志
    unsigned short disk;
    unsigned short refcnt;//引用计数
    BufferData *data;//缓冲区内存
    struct lock lock;//缓冲控制块锁
    struct list_elem Buffer_node;//链接到BufList中的节点
} Buffer;
```

```c
typedef struct BufferData {
    unsigned char data[BUF_SIZE];//BUF_SIZE = 512 
} BufferData;
```

## 簇层

因为FAT32文件系统会根据磁盘镜像的大小选取大小不同的簇。为了减少上层文件系统对扇区号的计算，在缓冲层的基础上又增添了簇层对于簇进行管理。

该层提供的主要功能是通过簇号来计算扇区号。

```c
unsigned long secno = clusterSec(fs, cluster) + offset / fs->superBlock.bpb.bytes_per_sec;
```

## 通用接口层

## 系统调用层